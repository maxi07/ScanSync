<div class="tab-pane" id="openai-tabpanel" role="tabpanel" aria-labelledby="openai-tab">
    <p>
        Choose your automatic file naming method:
    </p>
    <form id="file-naming-method-form">
        <div class="btn-group mb-3 w-100" role="group" aria-label="File naming method" style="flex-wrap: wrap;">
            <input type="radio" class="btn-check" name="file_naming_method" id="file_naming_none" value="none" autocomplete="off" {% if not openai_key and not ollama_enabled %}checked{% endif %}>
            <label class="btn btn-outline-light d-flex flex-row justify-content-center align-items-center py-2 flex-fill" for="file_naming_none" style="min-width: 90px; height: 48px;">
                None
            </label>

            <input type="radio" class="btn-check svg-icon" name="file_naming_method" id="file_naming_openai" value="openai" autocomplete="off" {% if openai_key %}checked{% endif %}>
            <label class="btn btn-outline-light d-flex flex-row justify-content-center align-items-center py-2 flex-fill" for="file_naming_openai" style="min-width: 90px; height: 48px;">
                <img src="/static/images/openai.svg" alt="OpenAI" style="height: 1.5em; vertical-align: middle; margin-right: 0.5em;">
                <span style="font-size: 0.95em;">OpenAI</span>
            </label>

            <input type="radio" class="btn-check svg-icon" name="file_naming_method" id="file_naming_ollama" value="ollama" autocomplete="off" {% if ollama_enabled %}checked{% endif %}>
            <label class="btn btn-outline-light d-flex flex-row justify-content-center align-items-center py-2 flex-fill" for="file_naming_ollama" style="min-width: 90px; height: 48px;">
                <img src="/static/images/ollama.svg" alt="Ollama" style="height: 1em; margin-right: 0.5em;">
                <span style="font-size: 0.95em;">Ollama</span>
            </label>
        </div>
    </form>
    <div id="none-options" style="display: {% if not openai_key and not ollama_enabled %}block{% else %}none{% endif %};">
        <p>Saving will disable and delete existing OpenAI or Ollama configurations.</p>
        <div id="file-naming-status" class="alert d-none" role="alert">
            <!-- Status message will appear here -->
        </div>
        <button class="btn btn-primary" id="save-none-button" onclick="disableFileNaming()">
            <i class="bi bi-floppy"></i> Save
        </button>
    </div>
    <div id="openai-options" style="display: {% if openai_key %}block{% else %}none{% endif %};">
        <p>
            Using OpenAI, we can add automatic file names to your scanned files. The content of the first page will be submitted
            to OpenAI to generate a file name.
            By entering your OpenAI API key, you agree to OpenAI's <a href="https://openai.com/terms/" target="_blank">Terms of
                Service</a> and <a href="https://openai.com/enterprise-privacy" target="_blank">Privacy
                Policy</a>.<br>
            <a href="https://openai.com/en-US/policies/privacy-policy/" role="button">Does OpenAI store my data?</a>
        </p>
        <div class="alert alert-dark d-flex align-items-center" role="alert" id="openAIDataAlert">
            <i class="bi bi-info-circle-fill me-2" style="font-size: 1.25rem;"></i>
            <div>
                You can find more info on API keys <a href="https://help.openai.com/en/articles/4936850-where-do-i-find-my-openai-api-key"
                    target="_blank" style="color: var(--bs-alert-link-color)">here</a> or get your API key <a
                    href="https://platform.openai.com/api-keys" target="_blank" style="color: var(--bs-alert-link-color)"> from
                    here</a>.
            </div>
        </div>
        <form id="openai-form">
            <div class="input-group">
                <span class="input-group-text" id="addon-wrapping"><i class="bi bi-key"></i></span>
                <input type="password" class="form-control" placeholder="OpenAI Key" aria-label="OpenAI key"
                    aria-describedby="addon-wrapping" id="openai_key" name="openai_key" value="{{ openai_key }}"
                    pattern="^sk-.{17,}$" required>
            </div>
            <br>
            {% if not openai_key %}
            <button type="submit" class="btn btn-primary animated-button" id="save-openai-button">
                <i class="bi bi-stars me-1"></i>Enable automatic file names with OpenAI
            </button>
            {% else %}
            <button type="button" class="btn btn-danger animated-button" id="delete-openai-button" onclick="deleteOpenAi()"><i class="bi bi-x-circle me-1"></i>Disable OpenAI filenames</button>
            {% endif %}
        </form>
    </div>
    <div id="ollama-options" style="display: {% if ollama_enabled %}block{% else %}none{% endif %};">
        <p>
            Use your own Ollama server for automatic file naming. The content of the first page will be sent to your Ollama server. Find the
            <a href="https://github.com/ollama/ollama?tab=readme-ov-file#ollama" target="_blank" role="button">Ollama setup guide</a> here.
            Make sure that your Ollama server is running and <a href="https://medium.com/@szz185/how-to-make-ollama-accessible-on-the-local-network-with-a-mac-mini-m-4-15e2d5364fdc" target="_blank">accessible from this device.</a>
        </p>
        <form id="ollama-form">
            <label for="ollama_server_scheme" class="form-label">Ollama Server URL</label>
            <div class="input-group mb-2">
                <select class="form-select" id="ollama_server_scheme" name="ollama_server_scheme" style="max-width: 90px;">
                    <option value="http" {% if (ollama_server_url or 'http://localhost').startswith('http://') %}selected{% endif %}>http</option>
                    <option value="https" {% if (ollama_server_url or '').startswith('https://') %}selected{% endif %}>https</option>
                </select>
                <input type="text" class="form-control" id="ollama_server_address" name="ollama_server_address" placeholder="localhost" value="{{ (ollama_server_url or 'http://localhost').replace('http://','').replace('https://','') }}" required style="min-width: 120px;">
                <span class="input-group-text px-2">:</span>
                <input type="number" class="form-control" id="ollama_server_port" name="ollama_server_port" value="{{ ollama_server_port or '11434' }}" min="1" max="65535" style="max-width: 90px;" required>
                <button type="button" class="btn btn-primary" id="ollama-connect-btn">
                    <span id="ollama-connect-btn-text"><i class="bi bi-plug me-1"></i>Connect</span>
                    <span id="ollama-connect-spinner" class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                </button>
            </div>
            <div id="ollama-version-info" class="alert alert-success mb-4 d-none"></div>
            <div id="ollama-models-section" style="display:{% if not ollama_server_url or not ollama_model %}none{% else %}block{% endif %};">
                <label for="ollama_model_select" class="form-label">Select Model</label>
                <div class="input-group mb-2">
                    <span class="input-group-text"><i class="bi bi-database"></i></span>
                    <select class="form-select" id="ollama_model_select" name="ollama_model_select" required>
                        <!-- Models will be populated here -->
                    </select>
                    <button type="submit" value="update_model" class="btn btn-primary {% if not ollama_enabled %}d-none{% endif %}" id="ollama-refresh-models-btn">
                        <i class="bi bi-check"></i> Select Model
                    </button>
                </div>
                <div id="ollama-model-info" class="form-text"></div>
            </div>
            <div id="ollama-error" class="alert alert-danger mt-2 d-none"></div>
            {% if not ollama_enabled %}
            <button type="submit" class="btn btn-success mt-3" id="ollama-save-btn" disabled><i class="bi bi-stars me-1"></i>Enable automatic file names with Ollama</button>
            {% else %}
            <button type="button" class="btn btn-danger mt-3" id="ollama-delete-btn" onclick="deleteOllama()"><i class="bi bi-x-circle me-1"></i>Disable Ollama filenames</button>
            {% endif %}
        </form>
    </div>
    <div class="accordion mt-4" id="logsAccordion">
        <div class="accordion-item">
            <h2 class="accordion-header" id="logsHeading">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#logsCollapse" aria-expanded="false" aria-controls="logsCollapse">
                    <i class="bi bi-journal-text me-2"></i> File Naming Logs
                </button>
            </h2>
            <div id="logsCollapse" class="accordion-collapse collapse" aria-labelledby="logsHeading" data-bs-parent="#logsAccordion">
                <div class="accordion-body">
                    <div id="logs-table-container">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="fw-semibold">Recent Activity</span>
                            <div class="d-flex align-items-center gap-2">
                                <select id="logs-success-filter" class="form-select form-select-sm" style="width: auto;">
                                    <option value="all">All</option>
                                    <option value="success">Success</option>
                                    <option value="failed">Failed</option>
                                </select>
                                <button class="btn btn-outline-secondary btn-sm" id="refresh-logs-btn" title="Refresh logs">
                                    <i class="bi bi-arrow-clockwise"></i>
                                </button>
                            </div>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-striped table-hover align-middle mb-0" id="logs-table">
                                <thead class="table-light">
                                    <tr>
                                        <th scope="col">#</th>
                                        <th scope="col">Status</th>
                                        <th scope="col">File Name</th>
                                        <th scope="col">Method</th>
                                        <th scope="col">Model</th>
                                        <th scope="col">Started</th>
                                        <th scope="col">Finished</th>
                                        <th scope="col">Error</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Logs will be dynamically inserted here -->
                                </tbody>
                            </table>
                        </div>
                        <nav aria-label="Logs pagination" class="mt-3">
                            <ul class="pagination justify-content-center mb-0" id="logs-pagination">
                                <!-- Pagination will be dynamically inserted here -->
                            </ul>
                        </nav>
                    </div>
                    <div id="logs-empty" class="text-center text-muted d-none py-4">
                        <i class="bi bi-inbox fs-2"></i>
                        <div>No logs found.</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script>
    const LOGS_PER_PAGE = 5;
    let logsPage = 1;
    let logsTotalPages = 1;
    let logsSuccessFilter = 'all';

    function fetchLogs(page = 1, filter = logsSuccessFilter) {
        document.querySelector('#refresh-logs-btn').disabled = true;
        let url = `/api/file-naming-logs?page=${page}&per_page=${LOGS_PER_PAGE}`;
        if (filter && filter !== 'all') {
            url += `&filter=${filter}`;
        }
        fetch(url)
            .then(res => res.json())
            .then(data => {
                renderLogsTable(data.logs, data.page, data.total_pages, data.total_count);
            })
            .catch(() => {
                renderLogsTable([], 1, 1, 0);
            })
            .finally(() => {
                document.querySelector('#refresh-logs-btn').disabled = false;
            });
    }

    function renderLogsTable(logs, page, totalPages, totalCount) {
        const tbody = document.querySelector('#logs-table tbody');
        const empty = document.getElementById('logs-empty');
        const pagination = document.getElementById('logs-pagination');
        tbody.innerHTML = '';
        if (!logs || logs.length === 0) {
            empty.classList.remove('d-none');
            document.getElementById('logs-table').classList.add('d-none');
            pagination.innerHTML = '';
            return;
        }
        empty.classList.add('d-none');
        document.getElementById('logs-table').classList.remove('d-none');
        logs.forEach((log, idx) => {
            const statusBadge = getStatusBadge(log.file_naming_status);
            // Show full error on click for mobile (and always show truncated with tooltip on desktop)
            let error = '';
            if (log.error_description) {
                const truncated = truncate(log.error_description, 40);
                error = `
                    <span class="text-danger" title="${log.error_description}" style="cursor:pointer;" onclick="if(window.innerWidth<768)alert('${log.error_description.replace(/'/g,"\\'").replace(/\n/g,'\\n')}')">
                        ${truncated}
                    </span>
                `;
            }
            // Truncate file name to 15 characters
            const truncatedFileName = truncate(log.file_name, 15);
            let fileNameHtml = '';
            if (log.file_name && log.file_name.length > 15) {
                fileNameHtml = `
                    <span title="${escapeHtml(log.file_name)}" style="cursor:pointer;" onclick="if(window.innerWidth<768)alert('${escapeHtml(log.file_name).replace(/'/g,"\\'").replace(/\n/g,'\\n')}')">
                        ${escapeHtml(truncatedFileName)}
                    </span>
                `;
            } else {
                fileNameHtml = escapeHtml(log.file_name);
            }
            tbody.innerHTML += `
                <tr>
                    <td>${log.id}</td>
                    <td>${statusBadge}</td>
                    <td>${fileNameHtml}</td>
                    <td>${escapeHtml(log.method)}</td>
                    <td>${escapeHtml(log.model)}</td>
                    <td><span class="text-secondary">${escapeHtml(log.started)}</span></td>
                    <td><span class="text-secondary">${escapeHtml(log.finished)}</span></td>
                    <td>${error}</td>
                </tr>
            `;
        });
        renderPagination(page, totalPages);
    }

    function renderPagination(page, totalPages) {
        const pagination = document.getElementById('logs-pagination');
        pagination.innerHTML = '';
        if (totalPages <= 1) return;
        let html = '';
        html += `<li class="page-item${page === 1 ? ' disabled' : ''}"><a class="page-link" href="#" data-page="${page-1}">&laquo;</a></li>`;
        for (let i = 1; i <= totalPages; i++) {
            if (i === 1 || i === totalPages || Math.abs(i - page) <= 1) {
                html += `<li class="page-item${i === page ? ' active' : ''}"><a class="page-link" href="#" data-page="${i}">${i}</a></li>`;
            } else if (i === page - 2 || i === page + 2) {
                html += `<li class="page-item disabled"><span class="page-link">…</span></li>`;
            }
        }
        html += `<li class="page-item${page === totalPages ? ' disabled' : ''}"><a class="page-link" href="#" data-page="${page+1}">&raquo;</a></li>`;
        pagination.innerHTML = html;
        pagination.querySelectorAll('a.page-link').forEach(link => {
            link.onclick = (e) => {
                e.preventDefault();
                const p = parseInt(link.getAttribute('data-page'));
                if (p >= 1 && p <= totalPages) fetchLogs(p, logsSuccessFilter);
            };
        });
    }

    function getStatusBadge(status) {
        switch (status) {
            case 'COMPLETED':
                return '<span class="badge bg-success">Completed</span>';
            case 'FAILED':
                return '<span class="badge bg-danger">Failed</span>';
            case 'PROCESSING':
                return '<span class="badge bg-warning text-dark">Processing</span>';
            default:
                return `<span class="badge bg-danger">${escapeHtml(status)}</span>`;
        }
    }

    function truncate(str, n) {
        return str && str.length > n ? str.slice(0, n - 1) + '…' : str;
    }

    function escapeHtml(text) {
        return text ? text.replace(/[&<>"']/g, function(m) {
            return ({
                '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'
            })[m];
        }) : '';
    }

    document.getElementById('refresh-logs-btn').onclick = () => fetchLogs(logsPage, logsSuccessFilter);

    document.getElementById('logs-success-filter').addEventListener('change', function() {
        logsSuccessFilter = this.value;
        fetchLogs(1, logsSuccessFilter);
    });

    document.addEventListener('DOMContentLoaded', () => {
        // Only fetch logs when the accordion is opened for the first time
        let loaded = false;
        const logsCollapse = document.getElementById('logsCollapse');
        logsCollapse.addEventListener('show.bs.collapse', function () {
            if (!loaded) {
                fetchLogs();
                loaded = true;
            }
        });
    });
    </script>
</div>
<script>
    let ollama_enabled = {{ ollama_enabled | tojson }};
    let ollamaModel = "{{ ollama_model | default('') }}";
</script>